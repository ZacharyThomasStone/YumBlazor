@page "/categories"
@inject ICategoryRepository _categoryRepository
@inject IJSRuntime _jsRuntime

<h3>CategoryList</h3>

@if(IsLoading)
{
	<div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
		<img src="/images/loading.gif" alt="loading"/>
	</div>
}
else
{
	<div class="card shadow border-0 mt-4">
		<div class="card-header bg-black bg-gradient m-lg-0 py-3">
			<div class="row">
				<div class="col-12 text-center">
					<h4 class="text-white mb-0">Categories</h4>
				</div>
			</div>
		</div>
		<div class="card-body p-4">
			<div class="row pb-3">
				<div class="col-12 text-end">
					<a href="category/create" class="btn btn-lg btn-secondary" style="width:250px;"><i class="bi bi-plus-square"></i> Add New Category</a>
				</div>
			</div>
			@if (Categories.Any())
			{
				<table class="table table-bordered table-striped">
					<thead>
						<tr>
							<th>Name</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var category in Categories)
						{
							<tr>
								<td>@category.Name</td>
								<td>
									<a href="@($"category/update/{category.Id}")" class="btn btn-sm btn-primary me-2"><i class="bi bi-pencil"></i> Edit</a>
									<button class="btn btn-sm btn-danger" @onclick="() => DeleteCategory(category.Id)" disabled="@IsDeleting">
										<i class="bi bi-trash"></i> 
										@if (IsDeleting)
										{
											<span class="spinner-border spinner-border-sm me-1" role="status"></span>
										}
										Delete
									</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			}
			else
			{
				<p class="text-center text-muted">No categories found.</p>
			}
		</div>
	</div>
}

@code {
	public bool IsLoading { get; set; } = true;
	public bool IsDeleting { get; set; } = false;
	public IEnumerable<Category> Categories { get; set; } = new List<Category>();
	public string ErrorMessage { get; set; } = string.Empty;
	public string SuccessMessage { get; set; } = string.Empty;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await LoadCategories();
			IsLoading = false;
			StateHasChanged();
		}
	}

	private async Task LoadCategories()
	{
		try
		{
			ErrorMessage = string.Empty;
			Categories = await _categoryRepository.GetAllAsync();
		}
		catch (Exception ex)
		{
			ErrorMessage = $"Error loading categories: {ex.Message}";
			Categories = new List<Category>();
		}
	}

		private async Task DeleteCategory(int id)
		{
			// Clear previous messages
			ErrorMessage = string.Empty;
			SuccessMessage = string.Empty;

			try
			{
				// Show confirmation dialog
				var confirmed = await _jsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this category?");
				if (!confirmed) return;

				// Prevent multiple concurrent delete operations
				if (IsDeleting) return;
			
				IsDeleting = true;
				StateHasChanged();

				// Perform delete operation
				var success = await _categoryRepository.DeleteAsync(id);
			
				if (success)
				{
					SuccessMessage = "Category deleted successfully.";
					await _jsRuntime.ToastrSucess("Category deleted successfully.");
					await LoadCategories(); // Reload categories
				}
				else
				{
					ErrorMessage = "Failed to delete category. Category may not exist.";
					await _jsRuntime.ToastrError(ErrorMessage);
				}
			}
			catch (Exception ex)
			{
				ErrorMessage = $"Error deleting category: {ex.Message}";
			}
			finally
			{
				IsDeleting = false;
				StateHasChanged();
			}
		}
}
